<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pantupphämtning</title>
  <meta name="description" content="Boka upphämtning av pantpåsar – fyll i adress och telefon (Swish) så får vi din bokning via Discord-notis. Enkelt och hemtrevligt.">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%2310b981'/%3E%3Ctext x='50' y='58' text-anchor='middle' font-size='54' fill='white' font-family='Segoe UI,Roboto,Helvetica,Arial,sans-serif'%3EP%3C/text%3E%3C/svg%3E"/>
  <link rel="preload" as="image" href="hempant_1.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .modal-open{overflow:hidden}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 via-white to-slate-100 text-stone-800">

  <!-- Header -->
  <header class="sticky top-0 z-20 backdrop-blur bg-white/70 border-b">
    <div class="mx-auto flex max-w-5xl items-center justify-between px-4 py-3">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-emerald-600"></div>
        <span class="font-semibold">HEMPANT</span>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <main class="mx-auto max-w-5xl px-4 pt-12 pb-24">
    <section class="text-center">
      <h1 class="text-3xl md:text-4xl font-semibold leading-tight">Hemtrevlig pantservice – vi hämtar där du bor</h1>
      <p class="mt-3 opacity-80">Tryck på knappen nedan för att boka upphämtning. Vi får din bokning via Discord-notis.</p>

      <!-- BIG CTA BUTTON -->
      <button id="openModal"
        class="mt-8 inline-flex items-center justify-center rounded-2xl bg-emerald-600 px-6 py-4 text-white text-lg font-semibold shadow hover:bg-emerald-700 active:scale-[0.99]">
        HÄMTA MIN PANT – BOKA!
      </button>

      <!-- Hero image -->
      <figure class="mx-auto mt-10 max-w-3xl">
        <img
          src="hempant_1.png"
          alt="HEMPANT hämtar pantpåsar vid dörren – bokning via webbformulär"
          class="w-[95%] md:w-[90%] mx-auto rounded-3xl border shadow-sm"
          loading="eager"
          decoding="async"
          fetchpriority="high"
          width="1600" height="900"
        />
      </figure>
    </section>

    <!-- Simple 4-step info -->
    <section class="mt-16 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="rounded-3xl border bg-white/70 p-5">
        <div class="text-lg font-semibold">1. Boka</div>
        <div class="opacity-80">Fyll i adress & telefon (Swish).</div>
      </div>
      <div class="rounded-3xl border bg-white/70 p-5">
        <div class="text-lg font-semibold">2. Vi hämtar</div>
        <div class="opacity-80">Vi kontaktar dig vid behov & kommer på överenskommen tid.</div>
      </div>
      <div class="rounded-3xl border bg-white/70 p-5">
        <div class="text-lg font-semibold">3. Registrering</div>
        <div class="opacity-80">Panten räknas/registreras.</div>
      </div>
      <div class="rounded-3xl border bg-white/70 p-5">
        <div class="text-lg font-semibold">4. Utbetalning</div>
        <div class="opacity-80">Swish – smidigt och snabbt.</div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div id="toastInner" class="rounded-2xl border bg-white shadow px-4 py-3 text-sm"></div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 z-40 hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div id="modalBackdrop" class="absolute inset-0 bg-black/40"></div>
    <div class="relative z-10 mx-auto mt-24 w-[92%] max-w-xl rounded-3xl border bg-white p-6 shadow-lg" tabindex="-1">
      <div class="flex items-center justify-between">
        <h2 id="modalTitle" class="text-xl font-semibold">Boka upphämtning</h2>
        <button id="closeModal" class="rounded-xl px-3 py-2 hover:bg-black/5" aria-label="Stäng dialog">Stäng</button>
      </div>

      <form id="bookingForm" class="mt-4 space-y-5">
        <label class="block">
          <div class="mb-1 text-sm font-medium">Adress *</div>
          <input name="adress" class="w-full rounded-2xl border bg-white/80 px-4 py-3 outline-none focus:ring ring-emerald-600/30"
                 placeholder="Ex. Storgatan 12, 123 45 Göteborg" required />
        </label>

        <label class="block">
          <div class="mb-1 text-sm font-medium">Telefon (Swish) *</div>
          <input name="telefon" class="w-full rounded-2xl border bg-white/80 px-4 py-3 outline-none focus:ring ring-emerald-600/30"
                 placeholder="07x-xx xx xxx eller +46…" required />
        </label>

        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <div class="mb-1 text-sm font-medium">Namn (valfritt)</div>
            <input name="namn" class="w-full rounded-2xl border bg-white/80 px-4 py-3 outline-none focus:ring ring-emerald-600/30"
                   placeholder="För- och efternamn" />
          </label>
          <label class="block">
            <div class="mb-1 text-sm font-medium">Önskad tid (valfritt)</div>
            <input type="datetime-local" name="onskadHamtningsTid"
                   class="w-full rounded-2xl border bg-white/80 px-4 py-3 outline-none focus:ring ring-emerald-600/30" />
          </label>
        </div>

        <p class="text-xs text-stone-600">
          * Vi använder telefonnumret både för kontakt och Swish-utbetalning.
        </p>

        <div class="flex items-center gap-3">
          <button id="submitBtn" type="submit"
                  class="rounded-2xl bg-emerald-600 px-5 py-3 text-white shadow hover:bg-emerald-700 active:scale-[0.99]">
            Skicka bokning
          </button>
          <button type="button" id="cancelBtn" class="rounded-2xl px-5 py-3 hover:bg-black/5">Avbryt</button>
        </div>
      </form>
    </div>
  </div>

  <footer class="border-t bg-white/50">
    <div class="mx-auto max-w-5xl px-4 py-8 text-sm opacity-80">© <span id="year"></span> HEMPANT</div>
  </footer>

  <script>
  // Tiny helpers
  const $ = (s, r=document) => r.querySelector(s);
  const showToast = (msg, ok=true) => {
    const wrap = $("#toast"), inner = $("#toastInner");
    inner.textContent = msg;
    inner.className = "rounded-2xl border px-4 py-3 text-sm shadow " + (ok ? "bg-emerald-50 border-emerald-300 text-emerald-900" : "bg-rose-50 border-rose-300 text-rose-900");
    wrap.classList.remove("hidden");
    setTimeout(() => wrap.classList.add("hidden"), 4000);
  };

  // Modal controls + focus trap (unchanged)
  const openModal = () => {
    $("#modal").classList.remove("hidden");
    document.body.classList.add("modal-open");
    const first = document.querySelector("#bookingForm input[name='adress']");
    setTimeout(() => first && first.focus(), 0);
    document.addEventListener("keydown", trap);
  };
  const closeModal = () => {
    $("#modal").classList.add("hidden");
    document.body.classList.remove("modal-open");
    document.removeEventListener("keydown", trap);
    $("#openModal").focus();
  };
  $("#openModal").addEventListener("click", openModal);
  $("#closeModal").addEventListener("click", closeModal);
  $("#cancelBtn").addEventListener("click", closeModal);
  $("#modalBackdrop").addEventListener("click", (e) => { if (e.target === e.currentTarget) closeModal(); });
  function trap(e){
    if (e.key === "Escape") { e.preventDefault(); closeModal(); return; }
    if (e.key !== "Tab") return;
    const focusables = Array.from(document.querySelectorAll("#modal button, #modal input, #modal select, #modal textarea, #modal [tabindex]:not([tabindex='-1'])"))
      .filter(el => !el.hasAttribute("disabled"));
    if (!focusables.length) return;
    const first = focusables[0], last = focusables[focusables.length - 1];
    if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
  }

  // Footer year + default datetime
  $("#year").textContent = new Date().getFullYear();
  (function setDefaultDT(){
    const input = document.querySelector("input[name='onskadHamtningsTid']");
    if (!input) return;
    const d = new Date(); d.setMinutes(0,0,0); d.setHours(d.getHours()+1);
    const pad = n => String(n).padStart(2,"0");
    input.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  })();

  // Swedish mobile validator (07… or +46 7…)
  function validPhone(v){
    if (!v) return false;
    const d = String(v).trim().replace(/[^\d+]/g, '');
    const reLocal = /^0?7[02369]\d{7}$/;   // 07XXXXXXXX
    const reE164  = /^\+467[02369]\d{7}$/; // +467XXXXXXXX
    return reLocal.test(d) || reE164.test(d);
  }

  // Submit handler with narrow catch (only network errors trigger the "server" toast)
  document.getElementById("bookingForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = document.getElementById("submitBtn");
    const fd = new FormData(e.currentTarget);
    const data = Object.fromEntries(fd.entries());

    const errs = [];
    if (!data.adress) errs.push("Adress saknas");
    if (!validPhone(data.telefon)) errs.push("Telefon ogiltigt (använd 07… eller +46…)");
    if (errs.length){ showToast("Korrigera: " + errs.join(", "), false); return; }

    btn.disabled = true; btn.textContent = "Skickar…";

    // 1) Do the network call with its own try/catch
    let resp;
    try {
      resp = await fetch("/api/book", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(data)
      });
    } catch (err) {
      console.error("Network error:", err);
      showToast("Kunde inte kontakta servern. Försök igen.", false);
      btn.disabled = false; btn.textContent = "Skicka bokning";
      return;
    }

    // 2) Decide success based on HTTP status (any 2xx = success)
    const is2xx = resp.status >= 200 && resp.status < 300;

    // Try to parse JSON, but don't fail UI if body is empty
    let json = null;
    try {
      const text = await resp.text();               // avoids errors on 204/empty
      json = text ? JSON.parse(text) : null;
    } catch (err) {
      // harmless: keep json = null
      console.debug("Response had no/invalid JSON (ok for 204/empty).");
    }

    if (is2xx && (!json || json.ok !== false)) {
      // Success path — show toast, reset, close modal
      showToast("Bokningen är skickad! Vi hör av oss vid behov.", true);
      e.currentTarget.reset();
      try { closeModal(); } catch (err) { console.warn("closeModal failed:", err); }
    } else if (resp.status === 429) {
      showToast("För många försök – vänta en liten stund och prova igen.", false);
    } else {
      const msg = json && json.error ? ("Fel: " + json.error) : "Något gick fel. Försök igen.";
      showToast(msg, false);
    }

    btn.disabled = false; btn.textContent = "Skicka bokning";
  });
</script>
